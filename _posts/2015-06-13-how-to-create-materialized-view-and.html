---
layout: post
title: How to create Materialized View and Automatic Refresh Scheduler in Oracle 11gR2
date: '2015-06-13T19:05:00.003-07:00'
author: Eko Junaidi Salam
tags:
- Oracle DBA
- Materialized View
- Oracle 11g
modified_time: '2015-07-08T11:46:42.645-07:00'
thumbnail: http://3.bp.blogspot.com/-HpSTuD6IjAQ/VZ1v8OXGtFI/AAAAAAAAJNA/mHaI1y5RpWQ/s72-c/Oracle-11g-RAC-Essentials-Certification-An-Overview.png
blogger_id: tag:blogger.com,1999:blog-4260504944092395316.post-2065127589586436533
blogger_orig_url: http://eko-artikel.blogspot.com/2015/06/how-to-create-materialized-view-and.html
---

<div style="text-align: justify;"><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-HpSTuD6IjAQ/VZ1v8OXGtFI/AAAAAAAAJNA/mHaI1y5RpWQ/s1600/Oracle-11g-RAC-Essentials-Certification-An-Overview.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="226" src="http://3.bp.blogspot.com/-HpSTuD6IjAQ/VZ1v8OXGtFI/AAAAAAAAJNA/mHaI1y5RpWQ/s400/Oracle-11g-RAC-Essentials-Certification-An-Overview.png" width="400" /></a></div><div style="text-align: center;">&nbsp;Sumber Gambar : http://annasophiawatts.com/wp-content/uploads/2014/12/Oracle-11g-RAC-Essentials-Certification-An-Overview.png</div>Before I post this article, I was troubled by MV configuration to refresh it manually. My MV is too complicated to tell it here, so I'll create it more simple.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Create a materialized view first, here is my simple MV :<br /><pre style="background-image: URL(http://2.bp.blogspot.com/_z5ltvMQPaa8/SjJXr_U2YBI/AAAAAAAAAAM/46OqEP32CJ8/s320/codebg.gif); background: #f0f0f0; border: 1px dashed #CCCCCC; color: black; font-family: arial; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;"> CREATE MATERIALIZED VIEW "some_schema"."MV_TEST_BRO" ("some_field", "some_field", "some_field")  <br /> ORGANIZATION HEAP PCTFREE 10 PCTUSED 0 INITRANS 2 MAXTRANS 255 NOCOMPRESS NOLOGGING  <br /> STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645  <br /> PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)  <br /> TABLESPACE "some_tablespace"   <br /> BUILD IMMEDIATE  <br /> USING INDEX   <br /> REFRESH COMPLETE ON DEMAND  <br /> USING DEFAULT LOCAL ROLLBACK SEGMENT  <br /> USING ENFORCED CONSTRAINTS DISABLE QUERY REWRITE  <br /> AS SELECT * FROM some_table;  <br /></code></pre><br />You can create it using REFRESH COMPLETE ON COMMIT or using FAST/FORCE mode. For detailed information please read <a href="http://docs.oracle.com/cd/B28359_01/server.111/b28286/statements_6002.htm" target="_blank">this</a>. After you update one of your table master you will get status NEED_COMPILE if you run this query :<br /><pre style="background-image: URL(http://2.bp.blogspot.com/_z5ltvMQPaa8/SjJXr_U2YBI/AAAAAAAAAAM/46OqEP32CJ8/s320/codebg.gif); background: #f0f0f0; border: 1px dashed #CCCCCC; color: black; font-family: arial; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;"> SELECT MVIEW_NAME, STALENESS, LAST_REFRESH_TYPE, COMPILE_STATE FROM USER_MVIEWS ORDER BY MVIEW_NAME;  <br /></code></pre><br /><a name='more'></a><br />After that I created a Schedules using DBMS_SCHEDULER like below this :<br /><pre style="background-image: URL(http://2.bp.blogspot.com/_z5ltvMQPaa8/SjJXr_U2YBI/AAAAAAAAAAM/46OqEP32CJ8/s320/codebg.gif); background: #f0f0f0; border: 1px dashed #CCCCCC; color: black; font-family: arial; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;"> BEGIN  <br />      sys.dbms_scheduler.create_schedule(  <br />      repeat_interval =&gt; 'FREQ=MINUTELY',  <br />      start_date =&gt; to_timestamp_tz('2015-06-09 01:41:55 Asia/Jakarta', 'YYYY-MM-DD HH24:MI:SS TZR'),  <br />      comments =&gt; 'Interval refresh 1 menit',  <br />      schedule_name =&gt; '"SOME_SCHEMA"."REFRESH_MV"');  <br /> END;  <br /></code></pre><br />MV and The Schedules has been created and now we create a DBMS_REFRESH to refresh every MV we have. This is My PL/SQL :<br /><pre style="background-image: URL(http://2.bp.blogspot.com/_z5ltvMQPaa8/SjJXr_U2YBI/AAAAAAAAAAM/46OqEP32CJ8/s320/codebg.gif); background: #f0f0f0; border: 1px dashed #CCCCCC; color: black; font-family: arial; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;"> BEGIN  <br />   DBMS_REFRESH.make(  <br />        name         =&gt; 'some_schema.MINUTE_REFRESH',  <br />        list         =&gt; '',  <br />        next_date      =&gt; SYSDATE,  <br />        interval       =&gt; '/*1:Mins*/ SYSDATE + 1/(60*24)',  <br />        implicit_destroy   =&gt; FALSE,  <br />        lax         =&gt; FALSE,  <br />        job         =&gt; 0,  <br />        rollback_seg     =&gt; NULL,  <br />        push_deferred_rpc  =&gt; TRUE,  <br />        refresh_after_errors =&gt; TRUE,  <br />        purge_option     =&gt; NULL,  <br />        parallelism     =&gt; 4,  <br />        heap_size      =&gt; NULL);  <br />   END;  <br />   BEGIN  <br />   DBMS_REFRESH.add(  <br />        name =&gt; 'some_schema.MINUTE_REFRESH',  <br />        list =&gt; 'some_schema.MV_TEST_BRO',  <br />        lax =&gt; TRUE);  <br />   END;  <br /></code></pre><br />For Automatic Refresh, we need Job Scheduler to do that so we create it one, using this PL/SQL below :<br /><pre style="background-image: URL(http://2.bp.blogspot.com/_z5ltvMQPaa8/SjJXr_U2YBI/AAAAAAAAAAM/46OqEP32CJ8/s320/codebg.gif); background: #f0f0f0; border: 1px dashed #CCCCCC; color: black; font-family: arial; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;"> BEGIN  <br /> sys.dbms_scheduler.create_job(  <br /> job_name =&gt; '"SOME_SCHEMA"."REFRESH_MV"',  <br /> job_type =&gt; 'PLSQL_BLOCK',  <br /> job_action =&gt; 'DECLARE  <br />   mv_name USER_MVIEWS.MVIEW_NAME%type;  <br />   mv_status USER_MVIEWS.STALENESS%type;  <br />   mv_last USER_MVIEWS.LAST_REFRESH_TYPE%type;  <br />   mv_state USER_MVIEWS.COMPILE_STATE%type;  <br />   CURSOR check_mv  <br />   IS SELECT MVIEW_NAME, STALENESS, LAST_REFRESH_TYPE, COMPILE_STATE FROM USER_MVIEWS WHERE MVIEW_NAME = ''MV_TEST_BRO'' ORDER BY MVIEW_NAME;  <br />   BEGIN  <br />     OPEN check_mv;  <br />     LOOP  <br />       FETCH check_mv INTO mv_name, mv_status, mv_last, mv_state;  <br />       IF mv_status != ''FRESH'' THEN  <br />         DBMS_REFRESH.REFRESH(name =&gt; ''SOME_SCHEMA.MINUTE_REFRESH'');  <br />       ELSE  <br />         EXIT;  <br />       END IF;  <br />       EXIT WHEN check_mv%NOTFOUND;  <br />     END LOOP;  <br />   CLOSE check_mv;  <br /> END;',  <br /> schedule_name =&gt; '"SOME_SCHEMA"."REFRESH_MV"',  <br /> job_class =&gt; '"DEFAULT_JOB_CLASS"',  <br /> comments =&gt; 'Refresh MV every 1 Minutes',  <br /> auto_drop =&gt; FALSE,  <br /> enabled =&gt; FALSE);  <br /> sys.dbms_scheduler.set_attribute( name =&gt; '"SOME_SCHEMA"."REFRESH_MV"', attribute =&gt; 'raise_events', value =&gt; dbms_scheduler.job_failed);  <br /> sys.dbms_scheduler.set_attribute( name =&gt; '"SOME_SCHEMA"."REFRESH_MV"', attribute =&gt; 'logging_level', value =&gt; DBMS_SCHEDULER.LOGGING_FAILED_RUNS);  <br /> sys.dbms_scheduler.set_attribute( name =&gt; '"SOME_SCHEMA"."REFRESH_MV"', attribute =&gt; 'restartable', value =&gt; TRUE);  <br /> sys.dbms_scheduler.enable( '"SOME_SCHEMA"."REFRESH_MV"' );  <br /> END;  <br /></code></pre><br />This Job running every minutes to check your Staleness status for your MV. If the status is not FRESH, this job will execute DBMS_REFRESH. The status is NEED_COMPILE, STALE,&nbsp; UNUSABLE or FRESH for staleness status.<br /><br />I've run this job scheduler over a week now, and I don't have a problem about that. My MV status is FRESH every time.</div>